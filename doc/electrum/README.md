# Electrum

The `Electrum` module exposes an implementation of the [Electrum protocol](https://electrumx.readthedocs.io/en/latest/protocol.html). The Electrum protocol itself
is an RPC protocol, build on JSONRPC. Although the original protocol supports both JSONRPC v1 and v2, we only support v2. This is because the v1 spec does not
officially support notifications.

## How to enable

The electrum server is not enabled by default. In order to enable it, the `x` module identifier needs to be specified for the modules flag when starting the deamon.
Note the that the electrum server depends on the explorer module (it won't start without it), and optionally uses the transactionpool module. Next, you also need to
specify an address to start the `tcp` listener or `websocket` listerner. The listerners are not started by default, only when an address is explicitly defined.
An example setup, which listens for websocket connections from the local network on port `7002` (and can be used for the [example](../examples/electrum/websocket.html)) would be:

```bash
rivined -M gctex --electrum-ws :7002
```

## Communicating with the server

After the connection has been established, the client can send either `requests` or `notifications` to the server. A notification is a request without
`ID` field. Notifications mean that the client is not interested in the resposne. Therefore the client also does not know if the request completed successfully,
or an error occured. For every request, a response will be send (except for notifications). This response contains a `result` field, or an `error` field. If either is
set, the other will not be set. Note that it is possible that neither field is set. Specifically, this happens when a method which does not return a result
completes without error.

Some methods will start a subscription. Subscriptions will send a notification to the client every time the thing subscribed to changes. The `method` of the notification
is the same as the `method` of the subscription. The `parameters` are defined in the [methods documentation](Methods.md).

If the client does not send any request for 10 minutes, the connection will be terminated by the server for being idle. If the client only wants to send a request
to reset the idle timer, the `server.ping` method should be used.

Request structure:

```javascript
{
    "id": "any",
    "method": "string",
    "params": {
        // defined in method documenetation
    },
    "jsonrpc": "2.0" // fixed value
}
```

As denoted above, the value of the `jsonrpc` field, which denotes the jsonrpc version used,  must be the string `"2.0"`. Any other value will result in an error.
The `id` field must, according to the official jsonrpc 2.0 spec, be either a string, number, or NULL. It can also be ommited entirely. If the `id` field is ommited or
has a `NULL` value, the `request is considered a notification.

Response structure:

```javascript
{
    "id": "any",
    "result": {
        // defined in method documentation
    },
    "error": {
        "code": 1, // NUMBER
        "message": "string",
        "data": {
            // optional data structure with additional info
        }
    },
    "jsonrpc": "2.0" // fixed value
}
```

As in requests, the `jsonrpc` field will always have the same fixed value of "2.0".
The `id` field will have the same value as the one in the request is responding to. Since abscence of the `id` field in a request denotes a notification, which does
not generate a response, the `id` field is always present and has a non NULL value in a response. If the request generated an error at any point, the `result` will
be ommited, and the `error` field value will be an object with at least the `code` and `message` field set to a non NULL value. If the call did not generate an error,
the `result` field value contains the result generated by the executed method. This result structure is defined in the method documentation. It is possible for a method
not to return a result.

## Version negotiation

To be able to change the protocol without forcing an upgrade of both server and client at the same time, the protocol is versioned. A protocol version is denoted as
`"a.b[.c]"`. Until the client has negotiated the exact protocol version to use, only the `server.ping` and `server.version` methods are supported. Therefore clients
should call `server.version` as soon as possible. If no protocol version is shared between the client and server, the server will close the connection without response.

## Supported connection types

Currently there are 2 supported connection types: 

- Websockets
- TCP

The websocket connection expects a single request (or batch request) to be send per frame. Likewise, a single response (or batch response) will be send per frame.